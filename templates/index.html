<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Benchmark</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .hash-text { font-size: 0.85rem; color: #555; }
    </style>
</head>
<body>
<div class="container py-5">
    <h2 class="text-center mb-4 fw-bold text-primary">Сравнение MD5, SHA-1, SHA-256, SHA-512</h2>
    
    <div class="row justify-content-center mb-4">
        <div class="col-md-10">
            <div class="card p-4">
                <form id="uploadForm" class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label for="fileInput" class="form-label fw-bold">Файл для теста</label>
                        <input type="file" class="form-control" id="fileInput" required>
                    </div>
                    <div class="col-md-4">
                        <label for="iterations" class="form-label fw-bold">Кол-во прогонов</label>
                        <input type="number" class="form-control" id="iterations" value="20" min="2" max="500">
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100 fw-bold" id="btnSubmit">START</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="resultsSection" class="d-none">
        <div class="row justify-content-center mb-4">
            <div class="col-md-10">
                <div class="card p-3">
                    <h5 class="card-title text-center">Динамика времени выполнения (ms)</h5>
                    <canvas id="lineChart" style="max-height: 400px;"></canvas>
                </div>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card p-4">
                    <h5 class="mb-3">Сводная статистика (размер файла: <span id="fileSize"></span> MB)</h5>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Алгоритм</th>
                                    <th>Среднее время (ms)</th>
                                    <th>Размер хеша (бит)</th>
                                    <th>Пример вывода</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let myChart = null;

const algorithmColors = {
    'MD5': '#ff6384',      // Красный
    'SHA-1': '#ff9f40',    // Оранжевый
    'SHA-256': '#36a2eb',  // Синий
    'SHA-512': '#9966ff'   // Фиолетовый
};

document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btnSubmit');
    const originalText = btn.innerText;
    btn.innerText = 'Working...';
    btn.disabled = true;

    const formData = new FormData();
    formData.append('file', document.getElementById('fileInput').files[0]);
    formData.append('iterations', document.getElementById('iterations').value);

    try {
        const response = await fetch('/benchmark', { method: 'POST', body: formData });
        const data = await response.json();
        if (data.error) { alert(data.error); return; }
        renderResults(data);
    } catch (err) {
        console.error(err);
        alert('Ошибка соединения с сервером');
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
});

function renderResults(data) {
    document.getElementById('resultsSection').classList.remove('d-none');
    document.getElementById('fileSize').innerText = data.file_size_mb;
    
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';

    const datasets = [];
    // Генерируем метки для оси X: 1, 2, 3 ... N
    const labels = Array.from({length: data.iterations_count}, (_, i) => i + 1);

    Object.keys(data.results).forEach(algo => {
        const res = data.results[algo];
        
        // Добавляем строку в таблицу
        tbody.innerHTML += `
            <tr>
                <td class="fw-bold" style="color: ${algorithmColors[algo]}">${algo}</td>
                <td>${res.avg_time_ms}</td>
                <td>${res.hash_length}</td>
                <td class="font-monospace hash-text text-truncate" style="max-width: 200px;" title="${res.hash}">${res.hash}</td>
            </tr>
        `;

        // Формируем датасет для графика
        datasets.push({
            label: algo,
            data: res.raw_times,
            borderColor: algorithmColors[algo],
            backgroundColor: algorithmColors[algo],
            tension: 0.3,       // Сглаживание линий (кривые Безье)
            pointRadius: 3,     // Размер точек
            pointHoverRadius: 6,
            fill: false
        });
    });

    // Рисуем график
    const ctx = document.getElementById('lineChart').getContext('2d');
    if (myChart) myChart.destroy();
    
    myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y + ' ms';
                        }
                    }
                },
                legend: { position: 'bottom' }
            },
            scales: {
                x: { title: { display: true, text: 'Номер итерации' } },
                y: { title: { display: true, text: 'Время (мс)' }, beginAtZero: false }
            }
        }
    });
}
</script>
</body>
</html>
